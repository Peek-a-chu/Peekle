#!/bin/sh

echo "üöÄ Running pre-push checks..."

# Get changed files in current branch compared to main
FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD)

# Check if frontend files changed
FRONTEND_CHANGED=$(echo "$FILES" | grep -E '^apps/frontend/' || true)
# Check if backend files changed
BACKEND_CHANGED=$(echo "$FILES" | grep -E '^apps/backend/' || true)

if [ -z "$FRONTEND_CHANGED" ] && [ -z "$BACKEND_CHANGED" ]; then
  echo "‚ÑπÔ∏è No frontend or backend files changed, skipping checks"
  exit 0
fi

# Frontend checks
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "\nüì¶ Frontend files changed, running checks..."
  
  echo "‚Ä¢ Running tests..."
  pnpm --filter frontend test --run
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend tests failed"
    exit 1
  fi

  echo "‚Ä¢ Building..."
  pnpm --filter frontend build
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend build failed"
    exit 1
  fi
  
  echo "‚úÖ Frontend checks passed"
fi

# Backend checks
if [ -n "$BACKEND_CHANGED" ]; then
  echo "\n‚òï Backend files changed, running checks..."
  
  echo "‚Ä¢ Running tests..."
  cd apps/backend && ./gradlew test --quiet
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend tests failed"
    exit 1
  fi

  echo "‚Ä¢ Building..."
  ./gradlew build -x test --quiet
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend build failed"
    exit 1
  fi
  
  echo "‚úÖ Backend checks passed"
fi

echo "\n‚úÖ All pre-push checks passed!"
