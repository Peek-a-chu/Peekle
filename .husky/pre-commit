#!/bin/sh

echo "üîç Running pre-commit checks..."

# Get list of staged files
FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if frontend files changed
FRONTEND_CHANGED=$(echo "$FILES" | grep -E '^apps/frontend/' || true)
# Check if backend files changed
BACKEND_CHANGED=$(echo "$FILES" | grep -E '^apps/backend/' || true)

if [ -z "$FRONTEND_CHANGED" ] && [ -z "$BACKEND_CHANGED" ]; then
  echo "‚ÑπÔ∏è No frontend or backend files changed, skipping checks"
  exit 0
fi

# Frontend checks
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "\nüì¶ Frontend files changed, running checks..."
  
  echo "‚Ä¢ Type checking..."
  pnpm --filter frontend type-check
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend type check failed"
    exit 1
  fi

  echo "‚Ä¢ Linting..."
  pnpm --filter frontend lint
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend lint failed"
    exit 1
  fi
  
  echo "‚úÖ Frontend checks passed"
fi

# Backend checks
if [ -n "$BACKEND_CHANGED" ]; then
  echo "\n‚òï Backend files changed, running checks..."
  
  echo "‚Ä¢ Compile checking..."
  cd apps/backend && ./gradlew compileJava --quiet
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend compile check failed"
    exit 1
  fi
  
  echo "‚úÖ Backend checks passed"
fi

echo "\n‚úÖ All pre-commit checks passed!"
